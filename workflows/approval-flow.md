# Approval Flow

> AI 작업의 승인 체계 정의

---

## Overview

AI Orchestrator Framework에서는 모든 중요한 결정에 사용자 승인이 필요합니다.
이 문서는 승인 레벨, 절차, 기준을 정의합니다.

---

## 승인 레벨

```
┌─────────────────────────────────────────────────────────────────────┐
│                        Approval Levels                               │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│   L1: 자동 승인                                                      │
│   ├── 일반 코드 변경                                                 │
│   ├── 테스트 통과 시 자동 진행                                       │
│   └── 사용자 개입 불필요                                             │
│                                                                      │
│   L2: 사용자 승인                                                    │
│   ├── 아키텍처 변경                                                  │
│   ├── 새 의존성 추가                                                 │
│   └── 중요 비즈니스 로직 변경                                        │
│                                                                      │
│   L3: 이중 승인                                                      │
│   ├── 보안 관련 변경                                                 │
│   ├── 인증/인가 로직                                                 │
│   └── 데이터베이스 스키마 변경                                       │
│                                                                      │
│   L4: 관리자 승인                                                    │
│   ├── 프로덕션 배포                                                  │
│   ├── 데이터 마이그레이션                                            │
│   └── 시스템 설정 변경                                               │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 레벨별 상세

### L1: 자동 승인

자동화된 검증 통과 시 자동으로 진행됩니다.

#### 대상
- 일반 코드 변경 (기존 패턴 내)
- 테스트 추가/수정
- 문서 업데이트
- 스타일 수정

#### 승인 조건
```
✅ 모든 테스트 통과
✅ 린트 통과
✅ 타입체크 통과
✅ 커버리지 기준 충족
```

#### 예시
```markdown
## 자동 승인 완료

변경 유형: L1 (일반 코드 변경)
검증 결과: 모든 검사 통과
상태: 자동 승인됨

→ 다음 단계로 자동 진행
```

---

### L2: 사용자 승인

중요한 변경사항은 사용자의 명시적 승인이 필요합니다.

#### 대상
- 아키텍처 변경
- 새 의존성 추가
- API 변경
- 중요 비즈니스 로직

#### 승인 절차

```
1. 변경 계획 제시
     ↓
2. 영향 분석 결과 제공
     ↓
3. 사용자 승인 요청
     ↓
4. [승인/수정/거부] 선택
     ↓
5. 승인 시 진행
```

#### 승인 요청 형식

```markdown
## 승인 요청

**변경 유형**: L2 (아키텍처 변경)

### 변경 내용
React Query를 도입하여 데이터 페칭 로직을 리팩토링합니다.

### 영향 범위
- 수정 파일: 15개
- 새 의존성: @tanstack/react-query

### 이점
- 캐싱 자동화
- 에러 핸들링 개선
- 코드량 감소

### 리스크
- 학습 곡선
- 기존 코드 마이그레이션 필요

### 승인 선택
- [ ] **승인** - 진행합니다
- [ ] **수정 요청** - 계획을 수정합니다
- [ ] **거부** - 진행하지 않습니다
```

---

### L3: 이중 승인

보안 관련 변경은 AI 검증 + 사용자 승인이 모두 필요합니다.

#### 대상
- 인증/인가 로직
- 암호화 관련 코드
- 민감 데이터 처리
- 데이터베이스 스키마 변경

#### 승인 절차

```
1. 변경 계획 제시
     ↓
2. Reviewer Agent 보안 검사
     ↓
3. 보안 검사 결과 제공
     ↓
4. 사용자 승인 요청
     ↓
5. [승인/거부] (수정 불가)
     ↓
6. 승인 시 진행
```

#### 승인 요청 형식

```markdown
## 보안 변경 승인 요청

**변경 유형**: L3 (보안 관련)
**심각도**: 높음

### 변경 내용
JWT 토큰 갱신 로직 수정

### 보안 검사 결과

| 항목 | 상태 | 설명 |
|------|------|------|
| 인증 우회 | ✅ 안전 | 우회 불가능 |
| 토큰 노출 | ✅ 안전 | HTTPS 필수 적용 |
| 세션 고정 | ✅ 안전 | 갱신 시 새 토큰 |

### 승인 선택
- [ ] **승인** - 보안 검사 결과를 확인하고 진행합니다
- [ ] **거부** - 진행하지 않습니다

⚠️ 보안 변경은 수정 요청이 불가합니다.
승인 전 계획을 충분히 검토해주세요.
```

---

### L4: 관리자 승인

프로덕션 환경에 영향을 미치는 변경은 최고 수준의 승인이 필요합니다.

#### 대상
- 프로덕션 배포
- 데이터베이스 마이그레이션
- 시스템 설정 변경
- 서비스 중단이 필요한 작업

#### 승인 절차

```
1. 변경 계획 제시
     ↓
2. 영향 분석 및 롤백 계획
     ↓
3. 사용자 1차 승인
     ↓
4. 관리자 2차 승인
     ↓
5. 모두 승인 시 진행
```

#### 승인 요청 형식

```markdown
## 프로덕션 변경 승인 요청

**변경 유형**: L4 (프로덕션 배포)
**예상 다운타임**: 없음 (무중단 배포)

### 변경 내용
사용자 프로필 기능 프로덕션 배포

### 배포 계획
1. 스테이징 최종 검증
2. 프로덕션 배포 (Blue-Green)
3. 헬스 체크 확인
4. 모니터링 활성화

### 롤백 계획
- 자동 롤백: 헬스 체크 실패 시
- 수동 롤백: 5분 내 가능

### 승인 상태
| 승인자 | 상태 | 시간 |
|--------|------|------|
| 개발자 (사용자) | ⏳ 대기 | - |
| 관리자 | ⏳ 대기 | - |

### 승인 선택
- [ ] **승인**
- [ ] **거부**
```

---

## 승인 위임

### 자동 승인 규칙

특정 조건에서 자동 승인을 설정할 수 있습니다:

```yaml
# .claude/approval-rules.yml

auto_approve:
  # L1은 항상 자동 승인
  level_1: true

  # L2 조건부 자동 승인
  level_2:
    conditions:
      - test_coverage: "> 90%"
      - files_changed: "< 5"
      - no_new_dependencies: true

  # L3, L4는 자동 승인 불가
  level_3: false
  level_4: false
```

---

## 승인 이력

모든 승인은 기록됩니다:

```markdown
## 승인 이력

| 일시 | 변경 | 레벨 | 승인자 | 결정 |
|------|------|------|--------|------|
| 2025-01-03 15:30 | 프로필 기능 | L2 | 사용자 | 승인 |
| 2025-01-03 16:00 | JWT 수정 | L3 | 사용자 | 승인 |
| 2025-01-03 17:00 | 배포 | L4 | 관리자 | 승인 |
```

---

## 거부 처리

### 거부 시 절차

```
1. 거부 사유 기록
     ↓
2. 대안 제시 (선택적)
     ↓
3. 작업 종료 또는 재계획
```

### 거부 사유 템플릿

```markdown
## 변경 거부

**거부 사유**: <사유>

**대안 제시**:
- <대안 1>
- <대안 2>

**다음 단계**:
- [ ] 대안으로 재계획
- [ ] 작업 취소
```

---

## 관련 문서

- [[CLAUDE]] - 핵심 규칙
- [[Workflow]] - 워크플로우 상세
- [[feature-development]] - 기능 개발 워크플로우
