name: PR Reminder

on:
  schedule:
    - cron: '0 9 * * 1-5'  # í‰ì¼ ì˜¤ì „ 9ì‹œ (UTC) = ì˜¤í›„ 6ì‹œ (KST)
  workflow_dispatch:

permissions:
  pull-requests: read
  issues: write

jobs:
  remind:
    name: Send PR Review Reminders
    runs-on: ubuntu-latest

    steps:
      - name: Get Pending PRs
        id: pending-prs
        uses: actions/github-script@v8
        with:
          script: |
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              sort: 'created',
              direction: 'asc'
            });

            const now = new Date();
            const pendingPRs = prs.filter(pr => {
              // Draft PR ì œì™¸
              if (pr.draft) return false;

              // ìƒì„± í›„ 24ì‹œê°„ ì´ìƒ ê²½ê³¼
              const created = new Date(pr.created_at);
              const hoursSinceCreation = (now - created) / (1000 * 60 * 60);
              return hoursSinceCreation >= 24;
            });

            if (pendingPRs.length === 0) {
              console.log('No pending PRs found');
              return { hasPRs: false };
            }

            const prList = pendingPRs.map(pr => {
              const created = new Date(pr.created_at);
              const days = Math.floor((now - created) / (1000 * 60 * 60 * 24));
              return `- [#${pr.number}](${pr.html_url}) ${pr.title} (${days}ì¼ ì „, @${pr.user.login})`;
            }).join('\n');

            console.log(`Found ${pendingPRs.length} pending PRs`);
            return { hasPRs: true, prList, count: pendingPRs.length };

      - name: Post Summary
        if: fromJson(steps.pending-prs.outputs.result).hasPRs
        uses: actions/github-script@v8
        with:
          script: |
            const result = ${{ steps.pending-prs.outputs.result }};

            // GitHub Job Summaryì— ê¸°ë¡
            await core.summary
              .addHeading('ğŸ“‹ Pending PR Review Reminder')
              .addRaw(`**${result.count}ê°œì˜ PRì´ ë¦¬ë·°ë¥¼ ê¸°ë‹¤ë¦¬ê³  ìˆìŠµë‹ˆë‹¤:**\n\n${result.prList}`)
              .write();

      - name: Send Slack Reminder
        if: fromJson(steps.pending-prs.outputs.result).hasPRs && vars.SLACK_WEBHOOK_URL != ''
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "ğŸ“‹ PR Review Reminder",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "${{ fromJson(steps.pending-prs.outputs.result).count }}ê°œì˜ PRì´ ë¦¬ë·°ë¥¼ ê¸°ë‹¤ë¦¬ê³  ìˆìŠµë‹ˆë‹¤.\n\n${{ fromJson(steps.pending-prs.outputs.result).prList }}"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View All PRs"
                      },
                      "url": "https://github.com/${{ github.repository }}/pulls"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ vars.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
