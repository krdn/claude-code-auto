name: PR Labeler

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  # ============================================
  # 파일 기반 라벨링
  # ============================================
  label-files:
    name: Label by Files
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Apply file-based labels
        uses: actions/labeler@v5
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          configuration-path: .github/labeler.yml
          sync-labels: true

  # ============================================
  # 크기 기반 라벨링
  # ============================================
  label-size:
    name: Label by Size
    runs-on: ubuntu-latest

    steps:
      - name: Label PR size
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const pr_number = context.payload.pull_request.number;

            // Get PR details
            const { data: pr } = await github.rest.pulls.get({
              owner,
              repo,
              pull_number: pr_number,
            });

            const additions = pr.additions;
            const deletions = pr.deletions;
            const totalChanges = additions + deletions;

            // Determine size label
            let sizeLabel;
            if (totalChanges < 50) {
              sizeLabel = 'size:s';
            } else if (totalChanges < 200) {
              sizeLabel = 'size:m';
            } else if (totalChanges < 500) {
              sizeLabel = 'size:l';
            } else {
              sizeLabel = 'size:xl';
            }

            // Remove existing size labels
            const existingLabels = pr.labels.map(l => l.name);
            const sizeLabels = ['size:s', 'size:m', 'size:l', 'size:xl'];

            for (const label of sizeLabels) {
              if (existingLabels.includes(label)) {
                await github.rest.issues.removeLabel({
                  owner,
                  repo,
                  issue_number: pr_number,
                  name: label,
                }).catch(() => {});
              }
            }

            // Add new size label
            await github.rest.issues.addLabels({
              owner,
              repo,
              issue_number: pr_number,
              labels: [sizeLabel],
            });

            console.log(`PR #${pr_number}: ${totalChanges} changes → ${sizeLabel}`);

  # ============================================
  # 승인 레벨 라벨링
  # ============================================
  label-approval:
    name: Label Approval Level
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine approval level
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const pr_number = context.payload.pull_request.number;

            // Get changed files
            const { data: files } = await github.rest.pulls.listFiles({
              owner,
              repo,
              pull_number: pr_number,
            });

            const filenames = files.map(f => f.filename);

            // Determine approval level based on files
            let approvalLevel = 'approval:l1'; // Default

            // L4: Production deployment
            if (filenames.some(f =>
              f.includes('deploy') ||
              f.includes('production') ||
              f.includes('Dockerfile')
            )) {
              approvalLevel = 'approval:l4';
            }
            // L3: Security related
            else if (filenames.some(f =>
              f.includes('auth') ||
              f.includes('security') ||
              f.includes('crypto') ||
              f.includes('secret') ||
              f.includes('token')
            )) {
              approvalLevel = 'approval:l3';
            }
            // L2: Architecture changes
            else if (filenames.some(f =>
              f.includes('architecture') ||
              f === 'package.json' ||
              f === 'tsconfig.json' ||
              f.includes('.github/workflows/')
            )) {
              approvalLevel = 'approval:l2';
            }

            // Remove existing approval labels
            const { data: pr } = await github.rest.pulls.get({
              owner,
              repo,
              pull_number: pr_number,
            });

            const existingLabels = pr.labels.map(l => l.name);
            const approvalLabels = ['approval:l1', 'approval:l2', 'approval:l3', 'approval:l4'];

            for (const label of approvalLabels) {
              if (existingLabels.includes(label)) {
                await github.rest.issues.removeLabel({
                  owner,
                  repo,
                  issue_number: pr_number,
                  name: label,
                }).catch(() => {});
              }
            }

            // Add new approval label
            await github.rest.issues.addLabels({
              owner,
              repo,
              issue_number: pr_number,
              labels: [approvalLevel],
            });

            console.log(`PR #${pr_number}: ${approvalLevel}`);
