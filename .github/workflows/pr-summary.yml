name: AI PR Summary

on:
  pull_request:
    types: [opened]

permissions:
  contents: read
  pull-requests: write
  issues: write
  id-token: write

jobs:
  summarize:
    name: Generate PR Summary
    runs-on: ubuntu-latest
    if: >
      github.event.pull_request.draft == false &&
      !contains(github.event.pull_request.user.login, 'bot') &&
      !contains(github.event.pull_request.user.login, '[bot]')

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if Summary Exists
        id: check-summary
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.pull_request.body || '';
            const hasSummary = body.includes('## ğŸ¤– AI Summary') || body.includes('## ğŸ“‹ Changes Summary');
            core.setOutput('exists', hasSummary.toString());

      - name: AI Summary with Claude (OAuth)
        if: steps.check-summary.outputs.exists != 'true'
        uses: anthropics/claude-code-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          timeout_minutes: "5"
          direct_prompt: |
            ì´ PRì˜ ë³€ê²½ì‚¬í•­ì„ ìš”ì•½í•´ì£¼ì„¸ìš”. í•œêµ­ì–´ë¡œ ì‘ì„±í•˜ê³  ë‹¤ìŒ í˜•ì‹ì„ ë”°ë¼ì£¼ì„¸ìš”:

            ## ğŸ¤– AI Summary

            ### ì£¼ìš” ë³€ê²½ì‚¬í•­
            - (ë³€ê²½ì‚¬í•­ 1)
            - (ë³€ê²½ì‚¬í•­ 2)

            ### ì˜í–¥ ë²”ìœ„
            - (ì˜í–¥ë°›ëŠ” ê¸°ëŠ¥ì´ë‚˜ ëª¨ë“ˆ)

            ### ë¦¬ë·° í¬ì¸íŠ¸
            - (ë¦¬ë·°ì–´ê°€ íŠ¹íˆ í™•ì¸í•´ì•¼ í•  ë¶€ë¶„)

            ê°„ê²°í•˜ê²Œ 3-5ë¬¸ì¥ìœ¼ë¡œ í•µì‹¬ë§Œ ìš”ì•½í•´ì£¼ì„¸ìš”.
