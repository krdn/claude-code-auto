name: Self-healing Loop

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types: [completed]

  # ìˆ˜ë™ íŠ¸ë¦¬ê±°
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to fix'
        required: false
        type: string

env:
  MAX_RETRIES: 3

jobs:
  # ============================================
  # CI ì‹¤íŒ¨ ë¶„ì„
  # ============================================
  analyze-failure:
    name: Analyze Failure
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    outputs:
      should_fix: ${{ steps.analyze.outputs.should_fix }}
      error_type: ${{ steps.analyze.outputs.error_type }}
      error_details: ${{ steps.analyze.outputs.error_details }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Get workflow run logs
        id: logs
        uses: actions/github-script@v7
        with:
          script: |
            const runId = context.payload.workflow_run.id;
            const jobs = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: runId
            });

            const failedJobs = jobs.data.jobs.filter(job => job.conclusion === 'failure');

            let errorInfo = [];
            for (const job of failedJobs) {
              errorInfo.push({
                name: job.name,
                steps: job.steps.filter(s => s.conclusion === 'failure').map(s => s.name)
              });
            }

            return JSON.stringify(errorInfo);

      - name: Analyze error type
        id: analyze
        run: |
          ERROR_INFO='${{ steps.logs.outputs.result }}'

          # ì—ëŸ¬ ìœ í˜• ë¶„ì„
          if echo "$ERROR_INFO" | grep -q "lint"; then
            echo "error_type=lint" >> $GITHUB_OUTPUT
            echo "should_fix=true" >> $GITHUB_OUTPUT
          elif echo "$ERROR_INFO" | grep -q "type"; then
            echo "error_type=type" >> $GITHUB_OUTPUT
            echo "should_fix=true" >> $GITHUB_OUTPUT
          elif echo "$ERROR_INFO" | grep -q "test"; then
            echo "error_type=test" >> $GITHUB_OUTPUT
            echo "should_fix=false" >> $GITHUB_OUTPUT
          else
            echo "error_type=unknown" >> $GITHUB_OUTPUT
            echo "should_fix=false" >> $GITHUB_OUTPUT
          fi

          echo "error_details=$ERROR_INFO" >> $GITHUB_OUTPUT

  # ============================================
  # ìžë™ ìˆ˜ì • ì‹œë„
  # ============================================
  auto-fix:
    name: Auto Fix
    runs-on: ubuntu-latest
    needs: analyze-failure
    if: needs.analyze-failure.outputs.should_fix == 'true'

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.workflow_run.head_branch }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Fix lint errors
        if: needs.analyze-failure.outputs.error_type == 'lint'
        run: |
          echo "ðŸ”§ Attempting to fix lint errors..."
          npm run lint:fix || true

          # ë³€ê²½ì‚¬í•­ í™•ì¸
          if git diff --quiet; then
            echo "No changes made by lint fix"
          else
            echo "Lint fixes applied"
          fi

      - name: Commit fixes
        id: commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if git diff --quiet; then
            echo "committed=false" >> $GITHUB_OUTPUT
          else
            git add -A
            git commit -m "fix: auto-fix lint errors

          ðŸ¤– Self-healing: Automatic lint fix applied

          Co-Authored-By: github-actions[bot] <github-actions[bot]@users.noreply.github.com>"
            git push
            echo "committed=true" >> $GITHUB_OUTPUT
          fi

      - name: Create issue if fix failed
        if: steps.commit.outputs.committed == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const errorType = '${{ needs.analyze-failure.outputs.error_type }}';
            const errorDetails = '${{ needs.analyze-failure.outputs.error_details }}';

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸ”§ Self-healing failed: ${errorType} errors`,
              body: `## Self-healing ì‹¤íŒ¨

            ìžë™ ìˆ˜ì •ì„ ì‹œë„í–ˆìœ¼ë‚˜ í•´ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.

            ### ì—ëŸ¬ ìœ í˜•
            \`${errorType}\`

            ### ìƒì„¸ ì •ë³´
            \`\`\`json
            ${errorDetails}
            \`\`\`

            ### í•„ìš” ì¡°ì¹˜
            - [ ] ì—ëŸ¬ ì›ì¸ ë¶„ì„
            - [ ] ìˆ˜ë™ ìˆ˜ì • ì ìš©
            - [ ] ìž¬í…ŒìŠ¤íŠ¸

            ---
            ðŸ¤– Auto-generated by Self-healing workflow`,
              labels: ['bug', 'self-healing-failed']
            });

  # ============================================
  # ìˆ˜ì • ê²°ê³¼ ì•Œë¦¼
  # ============================================
  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [analyze-failure, auto-fix]
    if: always() && needs.analyze-failure.result == 'success'

    steps:
      - name: Summary
        run: |
          echo "## Self-healing ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| í•­ëª© | ê°’ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| ì—ëŸ¬ ìœ í˜• | ${{ needs.analyze-failure.outputs.error_type }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ìžë™ ìˆ˜ì • ì‹œë„ | ${{ needs.analyze-failure.outputs.should_fix }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ìˆ˜ì • ê²°ê³¼ | ${{ needs.auto-fix.result }} |" >> $GITHUB_STEP_SUMMARY
